#!/usr/bin/env bash
set -euo pipefail

# shorthand-init: prepare dependencies and model for Shorthand CLI
# - Ensures Ollama is installed and running
# - Pulls llama3.2:3b if missing
# - Creates the cmdgen model from the Modelfile installed with Shorthand

info() { printf "[shorthand] %s\n" "$*"; }
warn() { printf "[shorthand] WARN: %s\n" "$*" >&2; }
die() { printf "[shorthand] ERROR: %s\n" "$*" >&2; exit 1; }

# Locate installed _coprompt.zsh for sourcing into the current zsh session
find_widget_path() {
  # 1) Homebrew installation path
  if command -v brew >/dev/null 2>&1; then
    local brew_prefix
    brew_prefix="$(brew --prefix)"
    local w1="$brew_prefix/opt/shorthand/share/shorthand/_coprompt.zsh"
    [[ -f "$w1" ]] && { printf "%s\n" "$w1"; return 0; }
  fi

  # 2) Manual install path (~/.local/share)
  local w2="$HOME/.local/share/shorthand/_coprompt.zsh"
  [[ -f "$w2" ]] && { printf "%s\n" "$w2"; return 0; }

  # 3) Relative to this repo checkout
  local script_dir
  script_dir="$(cd "$(dirname -- "$0")" && pwd)"
  local w3="$script_dir/../zsh/_coprompt.zsh"
  [[ -f "$w3" ]] && { printf "%s\n" "$w3"; return 0; }

  return 1
}

# Source the zsh widget into the current shell if we're running under zsh
source_widget_if_possible() {
  # Only attempt in zsh; sourcing a zsh widget in bash would error
  if [[ -n "${ZSH_VERSION:-}" ]]; then
    local widget
    if widget="$(find_widget_path 2>/dev/null)" && [[ -r "$widget" ]]; then
      # shellcheck disable=SC1090
      source "$widget" || true
    fi
  fi
}

# Ensure ~/.zshrc runs shorthand-init on new interactive shells (idempotent)
ensure_zshrc_autoload() {
  local rc="$HOME/.zshrc"
  local marker="# Shorthand: init"
  if ! grep -Fqx "$marker" "$rc" 2>/dev/null; then
    info "Adding shorthand-init to ~/.zshrc"
    {
      printf "\n%s\n" "$marker"
      printf "if command -v shorthand-init >/dev/null 2>&1; then\n"
      printf "  \"\$(command -v shorthand-init)\" >/dev/null 2>&1 || true\n"
      printf "fi\n"
    } >> "$rc"
    info "Added. Open a new terminal or run: exec zsh"
  else
    info "shorthand-init already present in ~/.zshrc"
  fi
}

# Resolve Modelfile path
resolve_modelfile() {
  # 1) SHORTHAND_MODELDIR env var
  if [[ -n "${SHORTHAND_MODELDIR:-}" && -f "$SHORTHAND_MODELDIR/Modelfile" ]]; then
    printf "%s\n" "$SHORTHAND_MODELDIR/Modelfile"
    return 0
  fi

  # 2) XDG-style local share (manual install)
  local xdg_mf="$HOME/.local/share/shorthand/Modelfile"
  if [[ -f "$xdg_mf" ]]; then
    printf "%s\n" "$xdg_mf"
    return 0
  fi

  # 3) Homebrew opt path
  if command -v brew >/dev/null 2>&1; then
    local brew_prefix
    brew_prefix="$(brew --prefix)"
    local mf1="$brew_prefix/opt/shorthand/share/shorthand/Modelfile"
    [[ -f "$mf1" ]] && { printf "%s\n" "$mf1"; return 0; }
  fi

  # 4) Relative to this repo (developer checkout)
  local script_dir
  script_dir="$(cd "$(dirname -- "$0")" && pwd)"
  local mf2="$script_dir/../Modelfile"
  [[ -f "$mf2" ]] && { printf "%s\n" "$mf2"; return 0; }

  return 1
}

ensure_ollama_installed() {
  if ! command -v ollama >/dev/null 2>&1; then
    warn "Ollama not found. Install with: brew install ollama"
    die "Ollama is required. See https://ollama.com/download for alternatives."
  fi
}

ensure_ollama_running() {
  # Try to start via brew services if available; otherwise background start
  if command -v brew >/dev/null 2>&1; then
    if ! pgrep -f "/Applications/Ollama.app|ollama serve" >/dev/null 2>&1; then
      info "Starting ollama service (brew services)..."
      brew services start ollama >/dev/null 2>&1 || true
      sleep 1
    fi
  fi
  # Final check: ping API
  if ! curl -sS http://127.0.0.1:11434/api/tags >/dev/null 2>&1; then
    info "Starting ollama in background..."
    (nohup ollama serve >/dev/null 2>&1 &)
    sleep 2
  fi
  # Validate reachable
  curl -sS http://127.0.0.1:11434/api/version >/dev/null || die "Ollama API not responding on 127.0.0.1:11434"
}

ensure_base_model() {
  if ! ollama list 2>/dev/null | awk '{print $1}' | grep -q "^llama3.2:3b$"; then
    info "Pulling base model llama3.2:3b (first time can take a while)..."
    ollama pull llama3.2:3b
  fi
}

ensure_cmdgen_model() {
  local modelfile_path="$1"
  if ! ollama list 2>/dev/null | awk '{print $1}' | grep -q "^cmdgen$"; then
    info "Creating cmdgen model from Modelfile..."
    ollama create cmdgen -f "$modelfile_path"
  else
    info "cmdgen model already exists. Use 'ollama rm cmdgen' to recreate."
  fi
}

main() {
  ensure_ollama_installed
  ensure_ollama_running
  ensure_base_model
  local mf
  if ! mf="$(resolve_modelfile)"; then
    die "Modelfile not found. Set SHORTHAND_MODELDIR or reinstall."
  fi
  ensure_cmdgen_model "$mf"
  # Load the widget now (when possible) and ensure future shells will run shorthand-init
  source_widget_if_possible
  ensure_zshrc_autoload
  info "Setup complete. Press Ctrl+G in this or a new terminal to use Shorthand."
}

main "$@"


